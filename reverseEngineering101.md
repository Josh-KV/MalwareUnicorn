TRIAGE ANALYSIS
---

File Context and Delivery
	- browser download

File Information & Header Analysis
	- binary file
	- file header indicates PE binary (first two bytes are MZ)

Get Basic PE information
	- Used PE Bear to check header info
		- The PE's use of 'FindResourceA' and 'CreateProcessA' indicate likely bad resource extraction then use in a new process

Simple Search
	- MD5: 29f228f3375c489a8a6e31203ab25787
	- SHA1: 14d713a5c8a2fc01fa2f01d993a249b9fb292810
	- https://www.virustotal.com/gui/file/ec905cb2cb8e9f74790adde2c138807f3a6cdbecd5735fa5035b547280d7db79/details

Collect Strings
	- Used BinText to display binary as ASCII
		- suspect strings included:
			- stage2.exe
			- Im totally malware
			- totally not malware

Quick VM Detonation
	- pop-up that says "Im totally malware" and "totally not malware"
	- no other obvious effects
	- Process Monitor on Victim VM shows lots of create file operations from Unknown.exe and stage2.exe as well as many DLL imports
	- likely that stage two turns any obfuscation/hidden or remote resources into harmful payload

Capture network information
	- Suspect HTTP packet found in wireshark:
		- "GET /l00k_wh4t_y0u_m4d3_m3_d0 HTTP/1.1"
		- TCP Stream reveals :Content-Type: text/html, User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:47.0) Gecko/20100101 Firefox/47.0, ==Host: definitely-not-evil.com==, Cache-Control: no-cache

Triage Summary:
	- message box with suspect dialog
	- might start new process with something extracted from resources
	- internet HTTP GET request for definitely-not-evil.com/l00k_wh4t_y0u_m4d3_m3_d0
	- creates stage2.exe file which also is quite active


STATIC ANALYSIS (Roadmap planning)
---

- /l00k_wh4t_y0u_m4d3_m3_d0 refferenced in `sub_401000`
- subroutine appears to connect to definitely-not-evil.com and send GET request for /l00k_wh4t_y0u_m4d3_m3_d0
- the subroutine then appears to use InternetReadFile to "open" the file which maybe opens it in memory rather than downloading to machine where AV might exterminate? (.text:004010E7)
- `sub_401000` is first sub run after `start`

- argument loaded from buffer:

```
.text:00401169                 lea     edi, [ebp-104h]		  ## effective address loaded into edi
.text:0040116F                 mov     byte ptr [ebp-104h], 0	  ## move the buffer contents into register 0
.text:00401176                 call    sub_401000			  ## call the subroutine function
.text:0040117B                 cmp     byte ptr [ebp-104h], 6Ch   ## compare buffer contents to 6Ch
```

- different location, loc_401269 appears get a filtered message, then translate the message, then dispatch the translated message. It also creates a window with CreateWindowExA named "oh_tay" with class "shake_it_off"

- after the HTTP get request, the response data is put into buffer:
```
.text:00401104                 push    eax             ; lpdwNumberOfBytesRead
.text:00401105                 push    0FEh            ; dwNumberOfBytesToRead
.text:0040110A                 push    edi             ; lpBuffer
.text:0040110B                 push    esi             ; hFile
.text:0040110C                 mov     [ebp+dwNumberOfBytesRead], 0
.text:00401116                 call    ebx ; InternetReadFile
```

- then the bytes of the buffer are compared against `6Ch, 6Dh, 61h, 6Fh`:
```
.text:00401176                 call    sub_401000				## get http request and put data into buffer
.text:0040117B                 cmp     byte ptr [ebp-104h], 6Ch		## if 0th byte of buffer doesn't match 6Ch, jump to
.text:00401182                 jnz     loc_4012E6				## loc_4012E6 which does "endp" to exit
.text:00401188                 cmp     byte ptr [ebp-103h], 6Dh		## if 1st byte of buffer doesn't match 6Dh, jump to
.text:0040118F                 jnz     loc_4012E6				## and so on...
.text:00401195                 cmp     byte ptr [ebp-102h], 61h
.text:0040119C                 jnz     loc_4012E6
.text:004011A2                 cmp     byte ptr [ebp-101h], 6Fh
.text:004011A9                 jnz     loc_4012E6
.text:004011AF                 mov     edi, ds:LoadIconA
```

Rough Roadmap:
---
Start \to (call sub_401000 \to HTTP GET request for data \to InternetReadFile into buffer .text:004010E7) and \to (compare buffer and jump to end program if no match)

Dynamic Analysis
---

- Revealed (using x32dbg) the functionality of the binary by manipulating the control flow to bypass the four logic checks (00401182, 0040118F, 0040119C, 004011A9)for the buffer data
- Full functionality summary:
	- `Unknown.exe` loads flag into the stack
	- `Unknown.exe` extracts file from resources which is uses to construct and then run process `stage2.exe` in the user folder `C:\Users\IEUser\AppData\Roaming`
	- `stage2.exe` sends HTTP GET request for definitely-not-evil.com/l00k_wh4t_y0u_m4d3_m3_d0
	- when `stage2.exe` sees "lmao" as the response to the GET request, it creates a window called "oh_tay" containing an image with the `flag:th4t_w4s_3asy!`
